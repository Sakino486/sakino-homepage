<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>画廊</title>
  <style>
    /* 添加必要的样式 */
    .content-item { margin-bottom: 20px; }
    .shuoshuo-item { padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .shuoshuo-header { display: flex; align-items: center; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
    .user-info { display: flex; flex-direction: column; }
    .nickname { font-weight: bold; }
    .post-time { font-size: 12px; color: #888; }
    .shuoshuo-text { margin-top: 10px; }
    .media-container { margin-top: 10px; }
    .media-thumbnail { max-width: 100px; max-height: 100px; margin-right: 10px; cursor: pointer; }
    #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; }
    #lightbox img, #lightbox video { max-width: 90%; max-height: 90%; }
  </style>
</head>
<body>
  <div id="authPanel">
    <input type="password" id="password" placeholder="请输入密码">
    <button onclick="verifyPassword()">登录</button>
  </div>
  <button id="postBtn" style="display:none;">发布</button>
  <div id="postPanel" style="display:none;">
    <div contenteditable="true" id="shuoshuoEditor" style="min-height:100px; border:1px solid #ccc; padding:10px;"></div>
    <input type="file" id="mediaUpload" multiple>
    <select id="fontSelector">
      <option value="Arial">Arial</option>
      <option value="Courier New">Courier New</option>
      <option value="Times New Roman">Times New Roman</option>
    </select>
    <input type="color" id="colorSelector">
    <button id="bgBtn">背景</button>
    <button id="submitBtn">提交</button>
    <button id="cancelBtn">取消</button>
  </div>
  <div id="status"></div>
  <div id="contentContainer"></div>
  <div id="lightbox" onclick="closeLightbox()">
    <img id="lightbox-img" style="display:none;">
    <video id="lightbox-video" controls style="display:none;"></video>
  </div>
  <script>
    const B2_CONFIG = {
      keyId: 'your_key_id',
      applicationKey: 'your_application_key',
      bucketId: 'your_bucket_id',
      bucketName: 'your_bucket_name',
      endpoint: 'https://f000.backblazeb2.com'
    };

    const userInfo = {
      nickname: '管理员',
      avatar: 'avatar.png'
    };

    document.addEventListener('DOMContentLoaded', () => {
      checkAuthStatus();
      loadContentFromB2();

      document.getElementById('postBtn').addEventListener('click', togglePostPanel);
      document.getElementById('cancelBtn').addEventListener('click', togglePostPanel);
      document.getElementById('submitBtn').addEventListener('click', publishContent);

      document.getElementById('fontSelector').addEventListener('change', changeFont);
      document.getElementById('colorSelector').addEventListener('input', changeColor);
      document.getElementById('bgBtn').addEventListener('click', setBackground);
    });

    async function loadContentFromB2() {
      try {
        updateStatus('正在从B2加载内容...');

        const authRes = await fetch('https://api.backblazeb2.com/b2api/v2/b2_authorize_account', {
          headers: {
            'Authorization': `Basic ${btoa(`${B2_CONFIG.keyId}:${B2_CONFIG.applicationKey}`)}`
          }
        });
        const { apiUrl, authorizationToken } = await authRes.json();

        const listRes = await fetch(`${apiUrl}/b2api/v2/b2_list_file_names`, {
          method: 'POST',
          headers: { 'Authorization': authorizationToken },
          body: JSON.stringify({
            bucketId: B2_CONFIG.bucketId,
            prefix: 'metadata/'
          })
        });

        const { files } = await listRes.json();

        if (!files || files.length === 0) {
          updateStatus('B2存储桶中没有内容');
          return;
        }

        const posts = [];
        for (const file of files) {
          const fileUrl = `${B2_CONFIG.endpoint}/file/${B2_CONFIG.bucketName}/${file.fileName}`;
          const res = await fetch(fileUrl);
          posts.push(await res.json());
        }

        posts.sort((a, b) => new Date(b.time) - new Date(a.time));
        renderContent(posts);
        updateStatus(`已加载 ${posts.length} 条内容`);
      } catch (error) {
        console.error('加载失败:', error);
        updateStatus('加载失败: ' + error.message);
      }
    }

    async function publishContent() {
      const editor = document.getElementById('shuoshuoEditor');
      const content = editor.innerHTML;
      const mediaInput = document.getElementById('mediaUpload');
      const submitBtn = document.getElementById('submitBtn');

      if (!content.trim() && mediaInput.files.length === 0) {
        alert('内容或媒体文件不能为空');
        return;
      }

      submitBtn.disabled = true;
      updateStatus('正在发布内容到B2...');

      try {
        const authRes = await fetch('https://api.backblazeb2.com/b2api/v2/b2_authorize_account', {
          headers: {
            'Authorization': `Basic ${btoa(`${B2_CONFIG.keyId}:${B2_CONFIG.applicationKey}`)}`
          }
        });
        const { apiUrl, authorizationToken } = await authRes.json();

        const uploadUrlRes = await fetch(`${apiUrl}/b2api/v2/b2_get_upload_url`, {
          method: 'POST',
          headers: { 'Authorization': authorizationToken },
          body: JSON.stringify({ bucketId: B2_CONFIG.bucketId })
        });
        const { uploadUrl, authorizationToken: uploadAuthToken } = await uploadUrlRes.json();

        const mediaUrls = [];
        for (const file of mediaInput.files) {
          const fileName = `media/${Date.now()}-${file.name.replace(/\s+/g, '_')}`;
          const encodedFileName = encodeURIComponent(fileName);

          const uploadRes = await fetch(uploadUrl, {
            method: 'POST',
            headers: {
              'Authorization': uploadAuthToken,
              'X-Bz-File-Name': encodedFileName,
              'Content-Type': file.type,
              'X-Bz-Content-Sha1': 'do_not_verify'
            },
            body: file
          });

          if (!uploadRes.ok) {
            throw new Error(`上传失败: ${file.name}`);
          }

          mediaUrls.push({
            type: file.type.startsWith('image') ? 'image' : 'video',
            url: `${B2_CONFIG.endpoint}/file/${B2_CONFIG.bucketName}/${fileName}`,
            mimetype: file.type
          });
        }

        const metadata = {
          type: 'shuoshuo',
          content: content,
          background: editor.style.background || '',
          nickname: userInfo.nickname,
          avatar: userInfo.avatar,
          time: new Date().toISOString(),
          media: mediaUrls
        };

        const metadataBlob = new Blob([JSON.stringify(metadata)], { type: 'application/json' });
        const metadataFileName = `metadata/${Date.now()}.json`;
        const encodedMetadataFileName = encodeURIComponent(metadataFileName);

        const metadataUploadRes = await fetch(uploadUrl, {
          method: 'POST',
          headers: {
            'Authorization': uploadAuthToken,
            'X-Bz-File-Name': encodedMetadataFileName,
            'Content-Type': 'application/json',
            'X-Bz-Content-Sha1': 'do_not_verify'
          },
          body: metadataBlob
        });

        if (!metadataUploadRes.ok) {
          throw new Error('元数据上传失败');
        }

        await loadContentFromB2();
        togglePostPanel();
        updateStatus('内容发布成功！');
      } catch (error) {
        console.error('发布错误:', error);
        updateStatus('发布失败: ' + error.message);
      } finally {
        submitBtn.disabled = false;
      }
    }

    function renderContent(posts) {
      const container = document.getElementById('contentContainer');
      container.innerHTML = posts.map(post => {
        if (post.type === 'shuoshuo') {
          return `
            <div class="content-item shuoshuo-item" style="background: ${post.background || 'white'}">
                            <div class="shuoshuo-header">
                <img src="${post.avatar}" class="avatar">
                <div class="user-info">
                  <div class="nickname">${post.nickname}</div>
                  <div class="post-time">${new Date(post.time).toLocaleString()}</div>
                </div>
              </div>
              <div class="shuoshuo-text">${post.content}</div>
              <div class="media-container">
                ${post.media?.map(media => media.type === 'image'
                  ? `<img src="${media.url}" class="media-thumbnail" onclick="showLightbox('${media.url}', 'image')">`
                  : `<video src="${media.url}" class="media-thumbnail" onclick="showLightbox('${media.url}', 'video')"></video>`
                ).join('') || ''}
              </div>
            </div>
          `;
        }
        return '';
      }).join('');
    }

    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }

    function togglePostPanel() {
      const panel = document.getElementById('postPanel');
      const btn = document.getElementById('postBtn');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      btn.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    function showLightbox(url, type) {
      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightbox-img');
      const video = document.getElementById('lightbox-video');
      if (type === 'image') {
        img.src = url;
        img.style.display = 'block';
        video.style.display = 'none';
      } else {
        video.src = url;
        video.style.display = 'block';
        img.style.display = 'none';
      }
      lightbox.style.display = 'flex';
    }

    function closeLightbox() {
      document.getElementById('lightbox').style.display = 'none';
      document.getElementById('lightbox-img').src = '';
      document.getElementById('lightbox-video').pause();
      document.getElementById('lightbox-video').src = '';
    }

    function verifyPassword() {
      const pwd = document.getElementById('password').value;
      if (pwd === 'your_password') {
        localStorage.setItem('auth', 'true');
        document.getElementById('authPanel').style.display = 'none';
        document.getElementById('postBtn').style.display = 'block';
      } else {
        alert('密码错误');
      }
    }

    function checkAuthStatus() {
      if (localStorage.getItem('auth') === 'true') {
        document.getElementById('authPanel').style.display = 'none';
        document.getElementById('postBtn').style.display = 'block';
      }
    }

    function changeFont() {
      const font = document.getElementById('fontSelector').value;
      document.execCommand('fontName', false, font);
    }

    function changeColor() {
      const color = document.getElementById('colorSelector').value;
      document.execCommand('foreColor', false, color);
    }

    function setBackground() {
      const editor = document.getElementById('shuoshuoEditor');
      const color = document.getElementById('colorSelector').value;
      editor.style.background = color;
    }
  </script>
</body>
</html>
